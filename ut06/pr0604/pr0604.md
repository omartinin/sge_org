# PR0604

## 1. Personalización del módulo

- Creamos los modelos:

    `models.py`
    ```
    import datetime
    from datetime import timedelta
    from odoo import models, fields, api
    from dateutil.relativedelta import relativedelta


    class subscription(models.Model):
        _name = 'subscription.subscription'
        _description = 'subscription.subscription'
        _sql_constraints = [('unique_name','unique(name)','El identificador ha de ser único.'),
                            ('unique_subscription_code','unique(subscription_code)','El código ha de ser único.')]

        name = fields.Char(required=True)
        customer_id = fields.Many2one(
            'res.partner',
            required=True
        )
        subscription_code = fields.Char(required=True)
        start_date = fields.Date(required=True, help="Fecha de Início", default = fields.Date.today)
        end_date = fields.Date()
        duration_months = fields.Integer(compute= "_compute_duration_months")
        renewal_date = fields.Date()
        status = fields.Selection(
            selection=[('active', 'Activa'),
                        ('expired', 'Finalizada'),
                        ('pending', 'Pendiente'),
                        ('cancelled', 'Cancelada')]
        )
        is_renewable = fields.Boolean()
        auto_renewal = fields.Boolean(default=True)
        price = fields.Float()
        usage_limit = fields.Integer()
        current_usage = fields.Integer(readonly=True)
        use_percent = fields.Float(compute = "_compute_porcentaje_uso")

        @api.depends('start_date', 'end_date')
        def _compute_duration_months(self):
            for record in self:
                delta = relativedelta(record.end_date, record.start_date)
                record.duration_months = delta.years * 12 + delta.months
                
        @api.depends('usage_limit', 'current_usage')
        def _compute_porcentaje_uso(self):
            for record in self:
                if record.usage_limit <= 0:
                    record.use_percent = 0
                    return
                record.use_percent = (float(record.current_usage * 100))/record.usage_limit

        def ampliar_subscripcion(self):
            for record in self:
                if record.end_date:
                    record.end_date = record.end_date + timedelta(days=15)
    ```


- Creamos las views:
  
    `views.xml`
    ```
    <odoo>
        <data>
            <!-- explicit list view definition -->

            <record model="ir.ui.view" id="view_subscription_tree_basic">
                <field name="name">subscription list</field>
                <field name="model">subscription.subscription</field>
                <field name="arch" type="xml">
                    <tree decoration-danger="status=='expired'" decoration-warning="status=='cancelled'" limit="15">
                        <field name="name" string="Identificador"/>
                        <field name="customer_id" string="Identificador del usuario"/> 
                        <field name="subscription_code" string="Código de la suscripción"/>
                        <field name="start_date" string="Fecha de inicip"/>
                        <field name="end_date" string="Fecha de finalización" widget="remaining_days"/>
                        <field name="duration_months" string="Meses de suscripción"/>
                        <field name="renewal_date" string="fecha de renovación"/>
                        <field name="status" string="Estado" widget="radio"/>
                        <field name="is_renewable" string="Es renovable"/>
                        <field name="auto_renewal" string="Renovación automatica"/>
                        <field name="price" string="Precio"
                                attrs="{'invisible': [('status', '=', 'cancelled')]}"/>
                        <button name="ampliar_subscripcion"
                                type="object"
                                string="Ampliar Subscripción"
                                class="btn-primary"/>
                    </tree>
                </field>
            </record>

            <record model="ir.ui.view" id="view_subscription_tree_usage">
                <field name="name">subscription list</field>
                <field name="model">subscription.subscription</field>
                <field name="arch" type="xml">
                    <tree>
                        <field name="usage_limit" string="Límite de uso"/>
                        <field name="current_usage" string="Usos realizados"/>
                        <field name="use_percent" string="Porcentaje de uso" decoration-danger="use_percent&gt;=80.0" widget="progressbar" avg="1"/>
                    </tree>
                </field>
            </record>


            <!-- actions opening views on models -->

            <record id="action_subscription_basic" model="ir.actions.act_window">
                <field name="name">Suscripciones (Básico)</field>
                <field name="res_model">subscription.subscription</field>
                <field name="view_mode">tree,form</field>
                <field name="view_id" ref="view_subscription_tree_basic"/>
            </record>
            <record id="action_subscription_usage" model="ir.actions.act_window">
                <field name="name">Suscripciones (Uso)</field>
                <field name="res_model">subscription.subscription</field>
                <field name="view_mode">tree,form</field>
                <field name="view_id" ref="view_subscription_tree_usage"/>
            </record>

            <!-- Top menu item -->

            <menuitem name="subscription" id="subscription.menu_root"/>

            <!-- menu categories -->

            <menuitem name="Básica" id="subscription.basica" parent="subscription.menu_root"/>
            <menuitem name="Usos" id="subscription.usos" parent="subscription.menu_root"/>

            <!-- actions -->

            <menuitem name="Básica" id="subscription.basica_list" parent="subscription.basica"
                    action="action_subscription_basic"/>
            <menuitem name="Usos" id="subscription.usos_list" parent="subscription.usos"
                    action="action_subscription_usage"/>

        </data>
    </odoo>
    ```

- Definimos los permisos de acceso a modelos:
  
    `ir.model.access.csv`
    ```
    id,name,model_id:id,group_id:id,perm_read,perm_write,perm_create,perm_unlink
    access_subscription_subscription,subscription.subscription,subscription.model_subscription_subscription,base.group_user,1,1,1,1
    ```

## 2. Capturas

- [View Básica](./capturas/view_basica.jpg)
- [View Usos](./capturas/view_usos.jpg)