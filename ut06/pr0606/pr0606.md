# PR0603

## 1. Personalización del módulo

- Creamos los modelos:

    `cliente.py`
    ```
    # -*- coding: utf-8 -*-

    from odoo import models, fields, api


    class cliente(models.Model):
        _name = 'taller.cliente'
        _description = 'taller.cliente'

        name = fields.Char(string='Nombre')
        telefono = fields.Char(string='Teléfono')
        email = fields.Char(
            string='Correo',
        )
        
        direccion = fields.Text()
        vehiculos = fields.One2many(
            string='Vehículos',
            comodel_name='taller.vehiculo',
            inverse_name='cliente',
        )
    ```

    `pieza.py`
    ```
    # -*- coding: utf-8 -*-

    from odoo import models, fields, api


    class pieza(models.Model):
        _name = 'taller.pieza'
        _description = 'taller.pieza'
        _sql_constraints = [('check_precio', 'check(precio_unitario > 0)','El precio ha de ser mayor que 0.')
                            ]
        
        name = fields.Char(
            string='Nombre',
        )

        codigo = fields.Char(
            string='Código',
        )
        
        precio_unitario = fields.Integer(
            string='Precio',
        )
        
        reparaciones = fields.Many2many(
            string='Reparaciones',
            comodel_name='taller.reparacion',
            relation='reparacion_pieza',
            column1='pieza_id',
            column2='reparacion_id',
        )
    ```

    `reparacion.py`
    ```
    # -*- coding: utf-8 -*-

    from odoo import models, fields, api


    class reparacion(models.Model):
        _name = 'taller.reparacion'
        _description = 'taller.reparacion'

        fecha_inicio = fields.Date(
            string='Fecha de inicio',
        )
        fecha_fin = fields.Date(
            string='Fecha de finalización',
        )
        
        descripcion = fields.Text(string='Descripción')
        estado = fields.Selection(
            string='Estado',
            selection=[('borrador', 'Borrador'), ('en_curso', 'En Curso'), ('finalizada', 'Finalizada')]
        )
        
        coste_total = fields.Integer(string='Total', compute='_calcular_coste_total')
        
        vehiculo = fields.Many2one(
            string='Vehículo',
            comodel_name='taller.vehiculo',
            ondelete='restrict',
        )
        
        piezas = fields.Many2many(
            string='Piezas',
            comodel_name='taller.pieza',
            relation='reparacion_pieza',
            column1='reparacion_id',
            column2='pieza_id',
        )
        
        tecnico = fields.Many2one(
            'res.users',
            string='Técnico'
        )

        @api.depends('piezas')
        def _calcular_coste_total(self):
            for record in self:
                record.coste_total = 0
                for pieza in record.piezas:
                    record.coste_total += pieza.precio_unitario

        def estado_en_curso(self):
            for record in self:
                if record.estado == "borrador":
                    record.estado = "en_curso"

        def estado_finalizada(self):
            for record in self:
                if record.estado == "en_curso":
                    record.estado = "finalizada"

        def estado_borrador(self):
            for record in self:
                if record.estado == "finalizada":
                    record.estado = "borrador"
    ```

    `vehiculo.py`
    ```
    # -*- coding: utf-8 -*-

    from odoo import models, fields, api


    class vehiculo(models.Model):
        _name = 'taller.vehiculo'
        _description = 'taller.vehiculo'

        name = fields.Char(string='Matrícula')
        marca = fields.Char(string='Marca')
        modelo = fields.Text(
            string='Modelo',
        )
        
        anio = fields.Integer(string='Año')
        cliente = fields.Many2one(
            string='Cliente',
            comodel_name='taller.cliente',
            ondelete='restrict',
        )
        
        reparaciones = fields.One2many(
            string='Reparaciones',
            comodel_name='taller.reparacion',
            inverse_name='vehiculo',
        )
    ```

- Creamos las views:
  
    `view_cliente.xml`
    ```
    <odoo>
        <data>
            <!-- explicit list view definition -->

            <record model="ir.ui.view" id="taller.list_cliente">
                <field name="name">Lista Clientes</field>
                <field name="model">taller.cliente</field>
                <field name="arch" type="xml">
                    <tree>
                        <field name="name"/>
                        <field name="telefono"/>
                        <field name="email"/>
                        <field name="direccion"/>
                        <field name="vehiculos"/>
                    </tree>
                </field>
            </record>


            <!-- actions opening views on models -->

            <record model="ir.actions.act_window" id="taller.action_cliente">
                <field name="name">Clientes</field>
                <field name="res_model">taller.cliente</field>
                <field name="view_mode">tree,form</field>
            </record>

        </data>
    </odoo>
    ```

    `view_menu.xml`
    ```
    <odoo>      
        <data>    
            <!-- Top menu item -->

            <menuitem name="Taller" id="taller.menu_root"/>

            <!-- menu categories -->

            <menuitem name="Clientes" id="taller.cliente_menu" parent="taller.menu_root"/>
            <menuitem name="Piezas" id="taller.pieza_menu" parent="taller.menu_root"/>
            <menuitem name="Reparaciones" id="taller.reparacion_menu" parent="taller.menu_root"/>
            <menuitem name="Vehículos" id="taller.vehiculo_menu" parent="taller.menu_root"/>

            <!-- actions -->

            <menuitem name="Lista de Clientes" id="taller.clientes_list_menu" parent="taller.cliente_menu"
                    action="taller.action_cliente"/>
            <menuitem name="Lista de Piezas" id="taller.piezas_list_menu" parent="taller.pieza_menu"
                    action="taller.action_pieza"/>
            <menuitem name="Lista de Reparaciones" id="taller.reparaciones_list_menu" parent="taller.reparacion_menu"
                    action="taller.action_reparacion"/>
            <menuitem name="Lista de Vehículos" id="taller.vehiculos_list_menu" parent="taller.vehiculo_menu"
                    action="taller.action_vehiculo"/>
        </data>
    </odoo>  
    ```

    `view_pieza.xml`
    ```
    <odoo>
        <data>
            <!-- explicit list view definition -->

            <record model="ir.ui.view" id="taller.list_pieza">
                <field name="name">Lista Piezas</field>
                <field name="model">taller.pieza</field>
                <field name="arch" type="xml">
                    <tree decoration-success="precio_unitario &lt; 10" decoration-danger="precio_unitario &gt; 100">
                        <field name="name"/>
                        <field name="codigo"/>
                        <field name="precio_unitario"/>
                        <field name="reparaciones"/>
                    </tree>
                </field>
            </record>


            <!-- actions opening views on models -->

            <record model="ir.actions.act_window" id="taller.action_pieza">
                <field name="name">Piezas</field>
                <field name="res_model">taller.pieza</field>
                <field name="view_mode">tree,form</field>
            </record>

        </data>
    </odoo>
    ```

    `view_reparacion.xml`
    ```
    <odoo>
        <data>
            <!-- explicit list view definition -->

            <record model="ir.ui.view" id="taller.list_reparacion">
                <field name="name">Lista Reparaciones</field>
                <field name="model">taller.reparacion</field>
                <field name="arch" type="xml">
                    <tree editable='top'>
                        <field name="fecha_inicio"
                                attrs="{'readonly': [('estado', '=', 'finalizada')]}"/>
                        <field name="fecha_fin"
                                attrs="{'readonly': [('estado', '=', 'finalizada')]}"/>
                        <field name="descripcion"
                                attrs="{'readonly': [('estado', '=', 'finalizada')]}"/>
                        <field name="estado"
                                decoration-info="estado=='en_curso'"
                                decoration-muted="estado=='borrador'"
                                decoration-success="estado=='finalizada'"
                                attrs="{'readonly': [('estado', '=', 'finalizada')]}"/>
                        <button name="estado_en_curso"
                                type="object"
                                string="Abrir Reparación"
                                attrs="{'invisible': [('estado', '!=', 'borrador')]}"
                                class="btn-success"/>
                        <button name="estado_finalizada"
                                type="object"
                                string="Cerrar Reparación"
                                attrs="{'invisible': [('estado', '!=', 'en_curso')]}"
                                class="btn-danger"/>
                        <button name="estado_borrador"
                                type="object"
                                string="Reabrir Reparación"
                                attrs="{'invisible': [('estado', '!=', 'finalizada')]}"
                                class="btn-info"/>
                        <field name="coste_total"
                                decoration-danger="coste_total &gt; 500"
                                decoration-warning="coste_total &gt;= 100 and coste_total &lt;= 500"
                                decoration-success="coste_total &lt; 100"
                                attrs="{'readonly': [('estado', '=', 'finalizada')]}"/>
                        <field name="vehiculo"
                                attrs="{'readonly': [('estado', '=', 'finalizada')]}"/>
                        <field name="piezas"
                                attrs="{'readonly': [('estado', '=', 'finalizada')]}"/>
                        <field name="tecnico"
                                attrs="{'readonly': [('estado', '=', 'finalizada')]}"/>
                    </tree>
                </field>
            </record>


            <!-- actions opening views on models -->

            <record model="ir.actions.act_window" id="taller.action_reparacion">
                <field name="name">Reparaciones</field>
                <field name="res_model">taller.reparacion</field>
                <field name="view_mode">tree,form</field>
            </record>

        </data>
    </odoo>
    ```

    `view_vehiculo.xml`
    ```
    <odoo>
        <data>
            <!-- explicit list view definition -->

            <record model="ir.ui.view" id="taller.list_vehiculo">
                <field name="name">Lista Vehículos</field>
                <field name="model">taller.vehiculo</field>
                <field name="arch" type="xml">
                    <tree>
                        <field name="name"/>
                        <field name="marca"/>
                        <field name="modelo"/>
                        <field name="anio"/>
                        <field name="cliente"/>
                        <field name="reparaciones"/>
                    </tree>
                </field>
            </record>


            <!-- actions opening views on models -->

            <record model="ir.actions.act_window" id="taller.action_vehiculo">
                <field name="name">Vehículos</field>
                <field name="res_model">taller.vehiculo</field>
                <field name="view_mode">tree,form</field>
            </record>

        </data>
    </odoo>
    ```

- Definimos los permisos de acceso a modelos:
  
    `ir.model.access.csv`
    ```
    id,name,model_id:id,group_id:id,perm_read,perm_write,perm_create,perm_unlink
    access_taller_cliente,taller.cliente,model_taller_cliente,base.group_user,1,1,1,1
    access_taller_pieza,taller.pieza,model_taller_pieza,base.group_user,1,1,1,1
    access_taller_reparacion,taller.reparacion,model_taller_reparacion,base.group_user,1,1,1,1
    access_taller_vehiculo,taller.vehiculo,model_taller_vehiculo,base.group_user,1,1,1,1
    ```

## 2. Capturas

- [Vista Cliente](./capturas/view_cliente.jpg)
- [Vista Pieza](./capturas/view_pieza.jpg)
- [Vista Reparación](./capturas/view_reparacion.jpg)
- [Vista Vehículo](./capturas/view_vehiculo.jpg)